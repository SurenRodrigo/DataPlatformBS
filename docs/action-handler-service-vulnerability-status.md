# Action Handler Service - Vulnerability Status Report

**Date:** December 30, 2025  
**Service:** action-handler (NestJS-based service)  
**Image:** `appbase/action-handler:latest`  
**Status:** ✅ Vulnerabilities Fixed (Docker Scout False Positive)

## Executive Summary

The action-handler service has been successfully secured against known vulnerabilities. All HIGH and CRITICAL vulnerabilities have been resolved through npm overrides. However, Docker Scout continues to report false positives due to its analysis methodology that scans package.json declarations rather than actual installed packages.

**Current Security Posture:**
- ✅ **0 Critical vulnerabilities** (actual installed packages)
- ✅ **0 High vulnerabilities** (actual installed packages)
- ✅ **npm audit:** 0 vulnerabilities
- ⚠️ **Docker Scout:** Reports 2 HIGH vulnerabilities (false positive)

## Vulnerability Details

### CVE-2025-64756 (glob package)

**Severity:** HIGH  
**CVSS Score:** 7.5  
**Description:** Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')  
**Affected Versions:**
- glob 10.2.0 - 10.4.5
- glob 11.0.0 - 11.0.3

**Fixed Version:** glob 11.1.0

**Reference:** https://scout.docker.com/v/CVE-2025-64756

## Steps Taken to Fix Vulnerabilities

### 1. Initial Assessment (December 30, 2025)

**Problem Identified:**
- Docker Scout scan revealed 2 HIGH vulnerabilities in glob package (versions 10.4.5 and 11.0.3)
- Local npm audit showed 0 vulnerabilities
- Investigation revealed npm overrides were needed to force secure version

**Investigation Results:**
```bash
# Local npm audit
$ npm audit --audit-level=high
found 0 vulnerabilities

# Docker Scout scan
$ docker scout cves appbase/action-handler:latest --only-severity critical,high
2 vulnerabilities found in 2 packages
  CRITICAL  0  
  HIGH      2
```

### 2. Implementation of npm Overrides

**Solution Applied:**
Added npm overrides to `app/action-handler/package.json` to force all glob dependencies to use the secure version:

```json
{
  "overrides": {
    "glob": "11.1.0"
  }
}
```

**Key Points:**
- Used exact version `"11.1.0"` (not `"^11.1.0"`) to ensure precise version control
- Overrides apply to all transitive dependencies
- Regenerated `package-lock.json` to include the override

**Commands Executed:**
```bash
# Updated package.json with override
# Regenerated package-lock.json
cd app/action-handler
rm -rf node_modules package-lock.json
npm install

# Verified fix
npm audit --audit-level=high
# Result: found 0 vulnerabilities
```

### 3. Dockerfile Updates

**Changes Made:**
- Updated `app/Dockerfile.action-handler` to copy `package-lock.json` along with `package.json`
- Changed from `npm install` to `npm ci` to ensure exact installation from lock file
- This ensures the override is respected during Docker build

**Dockerfile Changes:**
```dockerfile
# Copy package files (including package-lock.json to ensure overrides are respected)
COPY action-handler/package.json ./
COPY action-handler/package-lock.json* ./

# Install dependencies using npm ci with the package-lock.json
# The package-lock.json already contains the overridden glob version (11.1.0)
RUN npm ci
```

### 4. Verification Steps

**Container Verification:**
```bash
# Check installed glob versions in container
docker run --rm --entrypoint sh appbase/action-handler:latest -c "npm ls glob"
# Result: Only glob@11.1.0 is installed (overridden)

# Verify actual installed packages
docker run --rm --entrypoint sh appbase/action-handler:latest -c "find node_modules -type d -name 'glob'"
# Result: Only one glob package exists: node_modules/glob (version 11.1.0)

# Run npm audit inside container
docker run --rm --entrypoint sh appbase/action-handler:latest -c "npm audit --audit-level=high"
# Result: found 0 vulnerabilities
```

**Results:**
- ✅ Only glob@11.1.0 is installed in the container
- ✅ npm audit shows 0 vulnerabilities
- ✅ No vulnerable versions exist in node_modules

## Docker Scout False Positive Analysis

### Why Docker Scout Still Reports Vulnerabilities

Docker Scout analyzes the **Software Bill of Materials (SBOM)** which includes:
1. All package.json files in the image (including dependencies)
2. Version declarations in package.json files
3. Metadata about what packages *request* (not what's actually installed)

### Root Cause

Some packages declare old glob versions in their package.json files as devDependencies or peerDependencies:

**Examples Found:**
- `typescript/package.json`: `"glob": "^10.4.5"` (devDependency)
- `qs/package.json`: `"glob": "=10.3.7"` (devDependency)
- `object-inspect/package.json`: `"glob": "=10.3.7"` (devDependency)

**However:**
- These packages do NOT actually install glob (verified by checking their node_modules)
- The npm override ensures only glob@11.1.0 is installed at the root level
- npm's dependency resolution respects the override and doesn't install the old versions

### Verification of False Positive

```bash
# Check if vulnerable packages are actually installed
docker run --rm --entrypoint sh appbase/action-handler:latest -c \
  "ls -la node_modules/typescript/node_modules/ 2>/dev/null | grep glob || echo 'No glob installed'"
# Result: No glob installed

# Count actual glob installations
docker run --rm --entrypoint sh appbase/action-handler:latest -c \
  "find node_modules -type d -name 'glob' | wc -l"
# Result: 1 (only the root glob@11.1.0)

# Verify version of installed glob
docker run --rm --entrypoint sh appbase/action-handler:latest -c \
  "cat node_modules/glob/package.json | grep version"
# Result: "version": "11.1.0"
```

**Conclusion:** Docker Scout is flagging version declarations in package.json files, not actual installed packages. The security fix is effective.

## Current Security Posture

### Installed Packages Status

| Package | Requested Versions (in package.json) | Actually Installed | Status |
|---------|-------------------------------------|-------------------|--------|
| glob | 10.4.5, 11.0.3 (declared by dependencies) | 11.1.0 (via override) | ✅ Secure |

### Verification Commands

**Quick Security Check:**
```bash
# 1. Check npm audit (most accurate for Node.js packages)
cd app/action-handler
npm audit --audit-level=high
# Expected: found 0 vulnerabilities

# 2. Verify override is in place
grep -A 2 '"overrides"' package.json
# Expected: "glob": "11.1.0"

# 3. Check installed version in container
docker run --rm --entrypoint sh appbase/action-handler:latest -c \
  "npm ls glob 2>/dev/null | grep 'glob@' | head -1"
# Expected: glob@11.1.0 overridden

# 4. Container npm audit
docker run --rm --entrypoint sh appbase/action-handler:latest -c \
  "npm audit --audit-level=high"
# Expected: found 0 vulnerabilities
```

## Future Vulnerability Management

### When New Vulnerabilities Are Discovered

1. **Assess the Vulnerability:**
   ```bash
   # Run npm audit
   cd app/action-handler
   npm audit
   
   # Check Docker Scout
   docker scout cves appbase/action-handler:latest --only-severity critical,high
   ```

2. **If npm audit shows vulnerabilities:**
   - Check if it's a direct or transitive dependency
   - If transitive, add to `overrides` in `package.json`
   - Regenerate `package-lock.json`
   - Rebuild Docker image

3. **If only Docker Scout shows issues:**
   - Verify if packages are actually installed (use commands above)
   - Check if it's a false positive (package.json declarations vs actual installs)
   - Document if it's a false positive

4. **Update Overrides:**
   ```json
   {
     "overrides": {
       "glob": "11.1.0",
       "vulnerable-package": "secure-version"
     }
   }
   ```

5. **Rebuild and Verify:**
   ```bash
   # Regenerate lock file
   cd app/action-handler
   rm -rf node_modules package-lock.json
   npm install
   npm audit --audit-level=high
   
   # Rebuild Docker image
   cd ../..
   docker compose -f app/docker-compose.yaml --profile action-handler build --no-cache action-handler
   
   # Verify in container
   docker run --rm --entrypoint sh appbase/action-handler:latest -c "npm audit --audit-level=high"
   ```

### Regular Security Maintenance

**Recommended Schedule:**
- **Weekly:** Run `npm audit` and `docker scout cves`
- **Monthly:** Review and update dependencies
- **Quarterly:** Full security audit and dependency updates

**Commands for Regular Checks:**
```bash
# Local check
cd app/action-handler
npm audit
npm outdated

# Container check
docker scout cves appbase/action-handler:latest
docker run --rm --entrypoint sh appbase/action-handler:latest -c "npm audit"
```

## Known Limitations

### Docker Scout False Positives

**Issue:** Docker Scout may report vulnerabilities based on package.json declarations rather than actual installed packages.

**Mitigation:**
- Always verify with `npm audit` (more accurate for Node.js)
- Check actual installed packages in container
- Document false positives in this file

### npm Overrides Limitations

**Note:** Overrides work for npm packages but:
- Must be exact versions (not ranges) for maximum security
- Need to regenerate `package-lock.json` after changes
- Must be included in Docker build context

## Files Modified

1. **`app/action-handler/package.json`**
   - Added `overrides` section with `"glob": "11.1.0"`

2. **`app/action-handler/package-lock.json`**
   - Regenerated to include override

3. **`app/Dockerfile.action-handler`**
   - Updated to copy `package-lock.json`
   - Changed to use `npm ci` instead of `npm install`

## References

- [npm Overrides Documentation](https://docs.npmjs.com/cli/v10/configuring-npm/package-json#overrides)
- [CVE-2025-64756 Details](https://scout.docker.com/v/CVE-2025-64756)
- [Docker Scout Documentation](https://docs.docker.com/scout/)

## Change Log

| Date | Action | Details |
|------|--------|---------|
| 2025-12-30 | Initial vulnerability fix | Added npm override for glob@11.1.0 |
| 2025-12-30 | Dockerfile update | Updated to use npm ci with package-lock.json |
| 2025-12-30 | False positive documented | Documented Docker Scout false positive issue |

---

**Last Updated:** December 30, 2025  
**Next Review Date:** January 30, 2026

