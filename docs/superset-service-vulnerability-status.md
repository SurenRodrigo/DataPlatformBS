# Superset Remediation Strategy - Final Results
## Build from Source on Ubuntu 24.04 LTS

**Date:** 2025-11-16  
**Status:** ✅ **COMPLETED**  
**Final Results:** 0 Critical, 0 High, 2 Medium (unfixable)

---

## Executive Summary

Successfully remediated Superset vulnerabilities by building from source on Ubuntu 24.04 LTS base, achieving:
- **0 Critical vulnerabilities** (was 1) - pyarrow upgraded to 17.0.0
- **0 High vulnerabilities** (was 2) - cryptography upgraded to 43.0.3
- **2 Medium vulnerabilities** (was 4) - both unfixable Ubuntu base OS packages
- **Image size: 866 MB** (68% reduction from 2.74 GB baseline)
- **Production-ready WSGI server** - Gunicorn configured (development server warning removed)
- **Compatibility issues resolved** - marshmallow downgraded to 3.x for Superset 5.0.0 compatibility

---

## Final Results

### Vulnerability Summary

| Severity | Before | After | Status |
|----------|--------|-------|--------|
| Critical | 1 | **0** | ✅ Fixed |
| High | 2 | **0** | ✅ Fixed |
| Medium | 4 | **2** | ⚠️ Unfixable (base OS) |

### Image Size

- **Baseline:** 2.74 GB (single-stage, extending official image)
- **Final:** 866 MB (multi-stage build from source)
- **Reduction:** 68% smaller (1.87 GB saved)

### Packages Fixed

1. **pyarrow:** 14.0.2 → **17.0.0**
   - ✅ Fixed: CVE-2024-52338 (Critical)
   - Method: Upgraded with `--no-deps` to avoid numpy conflicts
   - Note: Successfully overrode Superset's dependency constraint

2. **cryptography:** 41.0.7 → **43.0.3**
   - ✅ Fixed: CVE-2023-50782 (High)
   - ✅ Fixed: CVE-2024-26130 (High)
   - ✅ Fixed: CVE-2024-0727 (Medium)
   - ✅ Fixed: GHSA-h4gh-qq45-vh27 (Medium)
   - Method: Explicit upgrade + purged system-level package

3. **marshmallow:** 4.1.0 → **3.20.0+ (<4.0.0)**
   - ✅ Fixed: Compatibility issue with Superset 5.0.0
   - Issue: marshmallow 4.x removed `minLength` parameter, causing `TypeError: Field.__init__() got an unexpected keyword argument 'minLength'`
   - Method: Force reinstall to compatible 3.x version (>=3.20.0,<4.0.0)
   - Note: Superset 5.0.0 requires marshmallow 3.x for compatibility

4. **Other packages upgraded:**
   - setuptools, jinja2, urllib3, brotli (all fixable vulnerabilities resolved)
   - gunicorn (production WSGI server)

### Remaining Vulnerabilities (Unfixable)

Both are in Ubuntu 24.04 LTS base OS packages with no fixes available:

1. **pam 1.5.3-5ubuntu5.5** - CVE-2025-8941 (Medium)
   - Status: No fix available in Ubuntu 24.04
   - Impact: Low (system-level package, minimal exposure)

2. **tar 1.35+dfsg-3build1** - CVE-2025-45582 (Medium)
   - Status: No fix available in Ubuntu 24.04
   - Impact: Low (system-level package, minimal exposure)

---

## Implementation Approach

### Strategy: Build from Source on Secure OS Base

Instead of extending the official `apache/superset:5.0.0` image, we built Superset from source on Ubuntu 24.04 LTS, giving us:

1. **Full Control Over Dependencies**
   - Upgrade pyarrow to 17.0.0 (fixes Critical vulnerability)
   - Control all Python package versions
   - Override Superset's dependency constraints when necessary

2. **Secure Base OS**
   - Ubuntu 24.04 LTS with latest security patches
   - Control system package versions
   - Better vulnerability posture than Debian Bookworm

3. **Optimized Multi-Stage Build**
   - Build stage: Install Superset and all dependencies
   - Runtime stage: Minimal image with only runtime dependencies
   - Significantly reduced image size

### Dockerfile Structure

```dockerfile
# Stage 1: Build Stage
FROM ubuntu:24.04 AS builder
# Install Python 3.11, build dependencies
# Install Apache Superset 5.0.0 from source
# Fix marshmallow compatibility (downgrade to 3.x for Superset 5.0.0)
# Upgrade pyarrow to 17.0.0 (--no-deps to avoid conflicts)
# Upgrade cryptography to 43.0.3
# Upgrade other vulnerable packages (setuptools, jinja2, urllib3, brotli)
# Install production dependencies (gunicorn, psycopg2-binary, flask-cors)

# Stage 2: Runtime Stage
FROM ubuntu:24.04
# Install only runtime dependencies (Python 3.11, postgresql-client, netcat)
# Copy virtual environment from builder
# Purge system-level cryptography package
# Set up Superset user and configuration
# Configure production WSGI server (Gunicorn via entrypoint script)
```

### Key Technical Decisions

1. **Python Version:** Python 3.11 (Ubuntu 24.04 defaults to 3.12, which Superset doesn't support)
2. **Base OS:** Ubuntu 24.04 LTS (more recent security patches than Debian Bookworm)
3. **pyarrow Upgrade:** Used `--no-deps` flag to prevent numpy 2.x upgrade (Superset requires numpy<2)
4. **cryptography Fix:** Explicit upgrade + purged system-level package to ensure only fixed version is present
5. **marshmallow Compatibility:** Downgraded to 3.x (>=3.20.0,<4.0.0) to fix `minLength` parameter compatibility issue with Superset 5.0.0
6. **Production WSGI Server:** Configured Gunicorn to replace development server (removes production warnings)
7. **Multi-Stage Build:** Separated build and runtime to minimize final image size

---

## Success Criteria - All Met ✅

- ✅ **0 Critical vulnerabilities** (pyarrow 17.0.0 fixed CVE-2024-52338)
- ✅ **0 High vulnerabilities** (cryptography 43.0.3 fixed all High CVEs)
- ✅ **2 Medium vulnerabilities** (both unfixable Ubuntu base OS packages - acceptable)
- ✅ **Image size: 866 MB** (68% reduction from 2.74 GB baseline)
- ✅ **Multi-stage build implemented** (minimized attack surface)
- ✅ **Linux compatibility** (built with `--platform linux/amd64`)
- ✅ **All fixable vulnerabilities fixed**
- ✅ **Production-ready WSGI server** (Gunicorn configured, development server warning removed)
- ✅ **Compatibility issues resolved** (marshmallow downgraded to 3.x for Superset 5.0.0)

---

## Comparison: Before vs After

### Before (Baseline)
- **Image:** Extending `apache/superset:5.0.0`
- **Size:** 2.74 GB
- **Vulnerabilities:** 1 Critical, 2 High, 4 Medium
- **Approach:** Single-stage build extending official image

### After (Final)
- **Image:** Built from source on Ubuntu 24.04 LTS
- **Size:** 866 MB (68% reduction)
- **Vulnerabilities:** 0 Critical, 0 High, 2 Medium (unfixable)
- **Approach:** Multi-stage build from source with full dependency control
- **WSGI Server:** Gunicorn (production-ready, replaces development server)
- **Compatibility:** marshmallow 3.x (fixed minLength parameter issue)

---

## Lessons Learned

1. **Build from Source Provides Control:** Building from source allowed us to override Superset's dependency constraints and fix the Critical pyarrow vulnerability.

2. **Multi-Stage Builds Reduce Size:** The multi-stage approach reduced image size by 68% while maintaining all functionality.

3. **Ubuntu 24.04 LTS is Secure:** Using Ubuntu 24.04 LTS provided better security posture than the Debian Bookworm base used by the official Superset image.

4. **Dependency Override Works:** Using `--no-deps` flag allowed us to upgrade pyarrow to 17.0.0 without breaking Superset's numpy requirements.

5. **System Package Purging:** Purging system-level packages (cryptography) ensured Docker Scout only sees the fixed version in the virtual environment.

6. **marshmallow Compatibility Fix:** Superset 5.0.0 requires marshmallow 3.x, but pip was installing 4.x which removed the `minLength` parameter. Force reinstalling to 3.x resolved the compatibility issue.

7. **Production WSGI Server:** Replaced development server (`superset run`) with Gunicorn for production deployment, removing development server warnings and improving performance.

---

## Next Steps

1. ✅ **Testing:** Verify Superset functionality with pyarrow 17.0.0
2. ✅ **Integration:** Update docker-compose.yaml to use new image
3. ✅ **Documentation:** Update PRD and remediation reports
4. ✅ **Production Configuration:** Configure Gunicorn WSGI server
5. ✅ **Compatibility Fixes:** Resolve marshmallow compatibility issue
6. ✅ **Functionality Verification:** All features tested and working
7. ⏳ **Production Deployment:** Deploy to production after testing

---

## Files Modified

- `platform/Dockerfile.superset` - Complete rewrite for build-from-source approach
  - Multi-stage build with Ubuntu 24.04 LTS base
  - Fixed marshmallow compatibility (downgraded to 3.x)
  - Added Gunicorn for production WSGI server
  - Upgraded pyarrow to 17.0.0 (Critical fix)
  - Upgraded cryptography to 43.0.3 (High fixes)
  - Purged system-level cryptography package
- `platform/superset_entrypoint.sh` - Updated for production deployment
  - Replaced `superset run` (development server) with Gunicorn
  - Configured production WSGI server with proper settings
  - Configurable worker count via `SUPERSET_GUNICORN_WORKERS` environment variable
- `platform/docker-compose.yaml` - Updated to use custom build
  - Added `platform: linux/amd64` for Linux compatibility
  - Updated image tag to `appbase/superset:source-build`
  - Added `APPBASE_CONFIG_DB_HOST` for entrypoint script
  - Added optional Gunicorn workers configuration comment

---

## References

- Docker Scout Scan Results: `docker scout cves appbase/superset:source-build`
- Build Command: `docker build --platform linux/amd64 --no-cache -t appbase/superset:source-build -f Dockerfile.superset .`
- Image Tag: `appbase/superset:source-build`
- Final Scan Date: 2025-11-16

---

## Production Configuration

### Gunicorn WSGI Server

Superset is configured to use Gunicorn as the production WSGI server, replacing the development server:

**Configuration:**
- **Workers:** 2 (configurable via `SUPERSET_GUNICORN_WORKERS` environment variable)
- **Threads:** 2 per worker (4 concurrent requests)
- **Timeout:** 120 seconds (for long-running Superset queries)
- **Request Limits:** Unlimited (0) for large queries
- **Worker Recycling:** Restart after 1000 requests (prevents memory leaks)
- **Logging:** Access and error logs to stdout/stderr
- **Preload:** Enabled for faster startup and lower memory usage

**Benefits:**
- ✅ No development server warnings
- ✅ Production-ready performance
- ✅ Better concurrency handling
- ✅ Memory leak prevention via worker recycling
- ✅ Configurable worker count for scaling

### Compatibility Fixes

**marshmallow Compatibility:**
- **Issue:** Superset 5.0.0 code uses `minLength` parameter which was removed in marshmallow 4.x
- **Error:** `TypeError: Field.__init__() got an unexpected keyword argument 'minLength'`
- **Solution:** Force reinstall marshmallow to compatible 3.x version (>=3.20.0,<4.0.0)
- **Result:** Superset starts successfully without compatibility errors

---

**Status:** ✅ **REMEDIATION COMPLETE**  
**All fixable vulnerabilities fixed. Remaining 2 Medium vulnerabilities are unfixable Ubuntu base OS packages. Production WSGI server configured and all compatibility issues resolved.**
